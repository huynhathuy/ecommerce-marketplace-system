CREATE TABLE GIFT (
	PromotionID CHAR(9),
	PRICE INT NOT NULL,
	QUANTITY INT NOT NULL,
	PRIMARY KEY (PromotionID),
	FOREIGN KEY (PromotionID) REFERENCES PROMOTION(ID) ON DELETE CASCADE
);

CREATE TABLE DISCOUNT (
	PromotionID CHAR(9),
	[PERCENTAGE] DECIMAL(5,4),
	AMOUNT INT,
	PRIMARY KEY (PromotionID),
	FOREIGN KEY (PromotionID) REFERENCES PROMOTION(ID) ON DELETE CASCADE,
	CHECK ([PERCENTAGE] IS NOT NULL OR AMOUNT IS NOT NULL)
);

CREATE TABLE TRAIN (
    VEHICLEID INT PRIMARY KEY,
    SERIALNUMBER VARCHAR(50),
    WAGONNO INT,
    FOREIGN KEY (VEHICLEID) REFERENCES VEHICLE(VEHICLEID) ON DELETE CASCADE
);

CREATE TABLE PLANE (
    VEHICLEID INT PRIMARY KEY,
    SERIALNUMBER VARCHAR(50),
    FOREIGN KEY (VEHICLEID) REFERENCES VEHICLE(VEHICLEID) ON DELETE CASCADE
);

CREATE TABLE MOTORBIKE (
    VEHICLEID INT PRIMARY KEY,
    LICENSEPLATE VARCHAR(20),
    FOREIGN KEY (VEHICLEID) REFERENCES VEHICLE(VEHICLEID) ON DELETE CASCADE
);

INSERT INTO GIFT (PromotionID, PRICE, QUANTITY) VALUES
('P00000001', 15000, 2016),
('P00000003', 30000, 1650),
('P00000005', 20000, 507),
('P00000006', 50000, 635),
('P00000008', 100000, 50);
GO

INSERT INTO DISCOUNT (PromotionID, [PERCENTAGE], AMOUNT) VALUES
('P00000002', 0.1000, NULL),  -- 10\% off
('P00000004', 0.1500, NULL),  -- 15\% off
('P00000007', 0.5000, NULL),  -- 50\% off
('P00000009', NULL, 99000),  -- 99,000VND off
('P00000010', NULL, 50000);   -- 50,000VND off
GO


INSERT INTO TRAIN (VEHICLEID, SERIALNUMBER, WAGONNO) VALUES
(V000000001, 'SE1-2024', 15),
(V000000002, 'TN2-2023', 10),
(V000000003, 'HN-SG-05', 12),
(V000000004, 'DN-HUE-11', 8),
(V000000005, 'SPT2-2025', 9);
GO

INSERT INTO PLANE (VEHICLEID, SERIALNUMBER) VALUES
(V000000006, 'VN-A321'),
(V000000007, 'VN-A858'),
(V000000008, 'VJ-BA12'),
(V000000009, 'QH-2219'),
(V000000010, 'VN-B789');
GO

INSERT INTO MOTORBIKE (VEHICLEID, LICENSEPLATE) VALUES
(V000000011, '59X3-456.78'),
(V000000012, '30H2-123.45'),
(V000000013, '92B1-678.99'),
(V000000014, '47E1-888.88'),
(V000000015, '51F5-222.33');
GO


-- Select promotions within a date range
CREATE PROCEDURE sp_GetPromotionSummary
    @StartDate DATE = NULL,
    @EndDate DATE = NULL
AS
BEGIN
    SELECT 
        p.[TYPE],
        COUNT(p.ID) AS TotalPromotions,
        SUM(ISNULL(g.PRICE * g.QUANTITY, 0)) AS TotalGiftValue,
        SUM(ISNULL(d.AMOUNT, 0)) AS TotalDiscountAmount,
        COUNT(DISTINCT p.AdminID) AS TotalAdmins
    FROM PROMOTION p
    LEFT JOIN GIFT g ON p.ID = g.PromotionID
    LEFT JOIN DISCOUNT d ON p.ID = d.PromotionID
    WHERE 
        (@StartDate IS NULL OR p.START_DATE >= @StartDate)
        AND (@EndDate IS NULL OR p.END_DATE <= @EndDate)
    GROUP BY 
        p.[TYPE]
    HAVING 
        COUNT(p.ID) > 0  -- Only show types with at least one promotion
    ORDER BY 
        TotalPromotions DESC;  -- Sort by most common promotion type
END;
GO

EXEC sp_GetPromotionSummary;
GO